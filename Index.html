<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Crypto Screener</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 0; }
    h1 { text-align: center; padding: 10px 0; background: #222; margin: 0; font-size: 20px; }
    table { width: 100%; border-collapse: collapse; margin: 20px auto; background: #1e1e1e; }
    th, td { padding: 10px; border: 1px solid #333; text-align: center; font-size: 14px; }
    th { background: #2a2a2a; }
    .section-title { background: #191919; color: #0f0; font-weight: bold; }
    .refresh-timer { text-align: center; font-size: 12px; padding: 5px; color: #ccc; }
    @media screen and (max-width: 600px) {
      table, th, td { font-size: 12px; }
    }
  </style>
</head>
<body>
  <h1>Advanced Crypto Screener</h1>
  <div class="refresh-timer">Next refresh in: <span id="timer">30</span>s</div>
  <div id="tables"></div>

  <script>
    const refreshRate = 30;
    let countdown = refreshRate;

    const timerEl = document.getElementById("timer");
    setInterval(() => {
      countdown--;
      if (countdown <= 0) {
        countdown = refreshRate;
        fetchData();
      }
      timerEl.textContent = countdown;
    }, 1000);

    async function fetchData() {
      const tableDiv = document.getElementById("tables");
      tableDiv.innerHTML = "";
      const response = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=percent_change_24h_desc&per_page=100&page=1&sparkline=true&price_change_percentage=24h");
      const data = await response.json();

      const categories = [
        { name: "20%+ Daily Gains", minGain: 20 },
        { name: "15%+ Daily Gains", minGain: 15 },
        { name: "10%+ Daily Gains", minGain: 10 },
        { name: "5%+ Daily Gains", minGain: 5 }
      ];

      categories.forEach(category => {
        const filtered = data.filter(c => c.price_change_percentage_24h >= category.minGain);
        if (filtered.length > 0) {
          const table = document.createElement("table");
          const headerRow = `
            <tr class="section-title"><th colspan="8">${category.name}</th></tr>
            <tr>
              <th>Name</th><th>Price</th><th>Market Cap</th><th>24h Change</th>
              <th>RSI</th><th>MACD</th><th>Signal</th><th>Hold Time</th>
            </tr>`;
          table.innerHTML = headerRow;

          filtered.slice(0, 5).forEach(coin => {
            const prices = coin.sparkline_in_7d.price;
            const rsi = calcRSI(prices);
            const macd = calcMACD(prices);
            const signal = getSignal(rsi, macd);

            const row = `
              <tr>
                <td>${coin.name}</td>
                <td>$${coin.current_price.toFixed(2)}</td>
                <td>$${coin.market_cap.toLocaleString()}</td>
                <td>${coin.price_change_percentage_24h.toFixed(2)}%</td>
                <td>${rsi.toFixed(1)}</td>
                <td>${macd.toFixed(3)}</td>
                <td>${signal}</td>
                <td>4h</td>
              </tr>`;
            table.innerHTML += row;
          });

          tableDiv.appendChild(table);
        }
      });
    }

    function calcRSI(prices) {
      const gains = [], losses = [];
      for (let i = 1; i < prices.length; i++) {
        const change = prices[i] - prices[i - 1];
        if (change > 0) gains.push(change);
        else losses.push(Math.abs(change));
      }
      const avgGain = gains.reduce((a, b) => a + b, 0) / gains.length || 0.01;
      const avgLoss = losses.reduce((a, b) => a + b, 0) / losses.length || 0.01;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    function calcMACD(prices) {
      const ema12 = calcEMA(prices, 12);
      const ema26 = calcEMA(prices, 26);
      return ema12 - ema26;
    }

    function calcEMA(prices, period) {
      const k = 2 / (period + 1);
      let ema = prices[0];
      for (let i = 1; i < prices.length; i++) {
        ema = prices[i] * k + ema * (1 - k);
      }
      return ema;
    }

    function getSignal(rsi, macd) {
      if (rsi < 30 && macd > 0) return "Buy";
      if (rsi > 70 && macd < 0) return "Sell";
      return "Hold";
    }

    fetchData();
  </script>
</body>
</html>
